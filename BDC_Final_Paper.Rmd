---
title: "Introducing DPAA: A Bayesian Approach To Evaluating Special Teams Defending Play Performance"
author: "Quinn MacLean"
theme: cerulean
output:
  word_document: default
  html_document:
    df_print: paged
  pdf_document: default
fontsize: 12pt
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,warning=FALSE,message=FALSE)

library(tidyverse)
library(gt)
library(ggplot2)
library(grid)
library(png)
library(RCurl)
library(bayesplot)
library(sjPlot)
library(gtsummary)
library(gganimate)
library(reshape2)
library(rstanarm)
library(ggimage)
library(magick)
library(ggpubr)
library(gridExtra)

### final datasets
defender.sim.mcmc<-read_csv("Summary/defender.sim.mcmc.csv") %>% dplyr::select(-`...1`)

pass.frame.sim.preds<-read_csv("Summary/pass_sim_preds.csv")



pass.success.mod.mcmc<-readRDS("Model/pass.success.mod.mcmc.rds")

pass<-read.csv("Summary/pass.csv")

## sample play - disregard
###sample<-read_csv("sample_tracking.csv")

##### roster data
CAN_USA_roster<-read_csv("Src/TrackingData/2022-02-08 Canada at USA/2022-02-08 Canada at USA roster.csv") %>%
  mutate(team_name = ifelse(team == "away","Canada","USA"))
ROC_FIN_roster<-read_csv("Src/TrackingData/2022-02-08 ROC at Finland/2022-02-08 ROC at Finland roster.csv") %>%
  mutate(team_name = ifelse(team == "away","ROC","Finland"))
SWISS_ROC_roster<-read_csv("Src/TrackingData/2022-02-12 Switzerland at ROC/2022-02-12 Switzerland at ROC roster.csv") %>%
  mutate(team_name = ifelse(team == "away","Switzerland","ROC"))
FIN_USA_roster<-read_csv("Src/TrackingData/2022-02-14 Finland at USA/2022-02-14 Finland at USA roster.csv") %>%
  mutate(team_name = ifelse(team == "away","USA","Finland"))
SWISS_CAN_roster<-read_csv("Src/TrackingData/2022-02-14 Switzerland at Canada/2022-02-14 Switzerland at Canada roster.csv") %>%
  mutate(team_name = ifelse(team == "away","Switzerland","Canada"))
SWISS_FIN_roster<-read_csv("Src/TrackingData/2022-02-16 Switzerland at Finland/2022-02-16 Switzerland at Finland roster.csv") %>%
  mutate(team_name = ifelse(team == "away","Switzerland","Finland"))
roster<-rbind(CAN_USA_roster,ROC_FIN_roster,SWISS_ROC_roster,FIN_USA_roster,SWISS_CAN_roster,SWISS_FIN_roster)

roster<-roster %>%
  dplyr::select(-team) %>%
  distinct()

rm(CAN_USA_roster)
rm(ROC_FIN_roster)
rm(SWISS_ROC_roster)
rm(FIN_USA_roster)
rm(SWISS_CAN_roster)
rm(SWISS_FIN_roster)

pass.frame.sim.preds<-pass.frame.sim.preds %>%
  left_join(roster,by=c("defender_num" = "jn","defender_team" = "team_name")) %>%
  rename("closest_defensive_player" = player,
         "defensive_position" = position.y)

pass_join<-pass %>%
  dplyr::filter(complete.cases(dis_event_des_x_abs)) %>%
  dplyr::select(playId,jn,separation,net_separation,closest_opp_player_separation,
                closest_event_player_separation,dis_event_x_abs,closest_opp_action_separation,
                dis_event_des_x_abs)
  


pass_metrics<-pass.frame.sim.preds %>%
  left_join(pass_join,by=c("playId","jn")) %>%
  group_by(defender_id) %>%
  summarize(n = n_distinct(playId),
            dis_event_x_abs = mean(dis_event_x_abs.y,na.rm=T),
            dis_event_des_x_abs = mean(dis_event_des_x_abs.y,na.rm = T),
            pass_distance = mean(pass_distance,na.rm = T),
            closest_opp_action_separation = mean(closest_opp_action_separation.y,na.rm = T),
            closest_opp_player_separation = mean(closest_opp_player_separation.y,na.rm = T),
            net_separation = mean(net_separation.y,na.rm = T),
            separation = mean(separation.y,na.rm = T)
            )

team_pass_metrics<-pass.frame.sim.preds %>%
  left_join(pass_join,by=c("playId","jn")) %>%
  group_by(defender_team) %>%
  summarize(n = n_distinct(playId),
            dis_event_x_abs = mean(dis_event_x_abs.y,na.rm=T),
            dis_event_des_x_abs = mean(dis_event_des_x_abs.y,na.rm = T),
            pass_distance = mean(pass_distance,na.rm = T),
            closest_opp_action_separation = mean(closest_opp_action_separation.y,na.rm = T),
            closest_opp_player_separation = mean(closest_opp_player_separation.y,na.rm = T),
            net_separation = mean(net_separation.y,na.rm = T),
            separation = mean(separation.y,na.rm = T)
            )


pass.frame.sim.preds<-pass.frame.sim.preds %>%
  left_join(roster,by=c("defender_num" = "jn","defender_team" = "team_name")) 

############ rink ##################
####################################
### creating a hockey rink with R
###
### plot the right or left half of an
### NHL or IIHF rink using ggplot2
###
### all definitions/coordinates here
### assumed to be relative to the
### center dot at (0, 0)
###
####################################


###### https://github.com/mtthwastn/statswithmatt/blob/master/hockey-with-r/gg-rink.R ####


gg_rink <- function(side = "right", specs = "nhl"){
  
  ### this function uses ggplot's annotate()
  # to draw the rink.
  # I recommend calling this function PRIOR to invoking
  # geoms for data so that the points aren't covered
  # by the annotations
  
  ### inputs:
  #     1. side = which side to plot: "right" (default) or "left"
  #     2. specs = which rink size to use: "nhl" (default) or "iihf" for
  #        international
  
  # check inputs
  side <- tolower(side)
  specs <- tolower(specs)
  stopifnot(side %in% c("right", "left"))
  stopifnot(specs %in% c("nhl", "iihf"))
  
  side <- switch(side,
                 "right" = 1,
                 "left" = -1)
  
  nsteps <- 1001 # line resolution for drawing circles/segments
  circle <- seq(0, 2*pi, length = nsteps) # angles to draw a circle
  
  img <- readPNG("Viz/BigDataCup.png")
  g <- rasterGrob(img, interpolate=TRUE)
  
  switch(specs,
         "nhl" = {
           # NHL specifications
           # all units in feet
           
           ### rink boundaries ###
           ## assumed to be standard 200x85ft dimensions
           x_max <- 100
           y_max <- 42.5
           y_min <- -y_max
           # blue line 75' from end boards
           x_blue <- x_max - 75
           # goal line 11' from end boards
           x_goal <- x_max - 11
           
           ### parameter setup
           ## corners rounded in arc of circle with 28' radius
           r_corner <- 28
           
           ## crease semi-circle
           # 6' radius from center of goal line starting 4.5' out
           crease_end <- 4.5
           r_crease <- 6
           # deepest point of net is 40"
           net_depth <- 40/12
           # crease is 8' long; goal posts 6' apart
           goal_post_start <- 6/2
           crease_start_y <- 8/2
           # inner crease lines begin 4' from goal line
           # extend 5" into crease
           crease_small_start <- 4
           crease_small_length <- 5/12
           
           ## face-off circle dots and lines
           # dot locations: 20' from goal line, 22' in each y direction
           x_dot_dist <- 20
           y_faceoff_dot <- 22
           # face-off circle radius 15'
           r_faceoff <- 15
           # hash marks 2' long, 5'7" apart
           hash_length <- 2
           hash_space <- 67/12
           # circle inner lines:
           # x-direction: lines 4' apart, so start 2' from dot
           # y-direction: lines 18" apart, so start 9" from dot
           inner_start_x <- 2
           inner_start_y <- 1.5/2
           # lines parallel to side boards: 4' long
           par_side_length <- 4
           # lines parallel to end boards: 3' long
           par_end_length <- 3
           
           ## other parameters
           # neutral zone dots are 5' from blue line, 44' apart
           x_dot_neutral <- 5
           # ref circle 5m radius
           r_ref <- 5
           ## trapezoid (NHL only)
           # begins 8' from each goal post
           # bottom base is 28' long
           y_traps_start <- goal_post_start + 8
           y_traps_end <- 14
         },
         "iihf" = {
           # IIHF specifications
           # all units in meters
           
           ### rink boundaries ###
           ## assumed to be standard 60x30m dimensions
           x_max <- 30
           y_max <- 15
           y_min <- -y_max
           # blue line 22.86m from end boards, 30cm wide
           x_blue <- x_max - 22.86
           # goal line 4m from end boards
           x_goal <- x_max - 4
           
           ### parameter setup
           ## corners rounded in arc of circle with 8.5m radius
           r_corner <- 8.5
           
           ## crease semi-circle
           # 183cm radius from center of goal line starting 137cm out
           crease_end <- 1.37
           r_crease <- 1.83
           # deepest point of net is 1.12m
           net_depth <- 1.12
           # crease is 244cm long; goal posts 183.5cm apart
           goal_post_start <- 1.835/2
           crease_start_y <- 2.44/2
           # inner crease lines begin 122cm from goal line
           # extend 13m into crease
           crease_small_start <- 1.22
           crease_small_length <- 0.13
           
           ## face-off circle dots and lines
           # dot locations: 6m from goal line, 7m in each y direction
           x_dot_dist <- 6
           y_faceoff_dot <- 7
           # face-off circle radius 4.5m
           r_faceoff <- 4.5
           # hash marks 60cm long, 170cm apart
           hash_length <- 0.6
           hash_space <- 1.7
           # circle inner lines:
           # x-direction: lines 120cm apart, start 60cm from dot
           # y-direction: lines 45cm apart, so start 22.5cm from dot
           inner_start_x <- 0.6
           inner_start_y <- 0.225
           # lines parallel to side boards: 120cm long
           par_side_length <- 1.2
           # lines parallel to end boards: 90cm long
           par_end_length <- 0.9
           
           ## other parameters
           # neutral zone dots are 1.5m from blue line
           x_dot_neutral <- 1.5
           # ref circle 3m radius
           r_ref <- 3
         }
  )
  
  ## corners
  curve_angle <- seq(pi/2, 0, length = nsteps)
  curve_angle_last <- curve_angle[nsteps]
  # y coord at end of curve to connect ends
  y_curve_end <- (y_max - r_corner) + r_corner*sin(curve_angle_last)
  # for goal line, find y coord when x is at goal line
  goal_angle <- acos(
    (x_goal - (x_max - r_corner))/r_corner
  )
  y_goal <- (y_max - r_corner) + r_corner*sin(goal_angle)
  
  ## crease
  crease_angles <- seq(
    pi - acos(crease_end/r_crease),
    pi + acos(crease_end/r_crease),
    length = nsteps
  )
  
  ## face-off circle
  x_faceoff_dot <- x_goal - x_dot_dist
  # find y coord on circle where hashes begin
  y_hash <- r_faceoff*sin(
    acos((hash_space/2)/r_faceoff)
  )
  
  ### create list of components to pass to ggplot
  list(
    theme_minimal(),
    theme(panel.grid = element_blank()),
    ### blue line
    annotate(
      "segment",
      x = x_blue*side, y = y_max,
      xend = x_blue*side, yend = y_min,
      color = "blue", size = 2
    ),
    ### ref crease
    annotate(
      "path",
      x = r_ref*cos(seq(pi/2, 0, length = nsteps))*side,
      y = y_min + r_ref*sin(seq(pi/2, 0, length = nsteps)),
      color = "red"
    ),
    ### face-off circle, center ice
    annotate(
      "path",
      x = r_faceoff*cos(seq(pi/2, -pi/2, length = nsteps))*side,
      y = r_faceoff*sin(seq(pi/2, -pi/2, length = nsteps)),
      color = "blue"
    ),
    annotation_custom(g, xmin=35, xmax=55, ymin=-20, ymax=20),
    ### center line:
    annotate(
      "segment",
      x = 0, y = y_max,
      xend = 0, yend = y_min,
      color = "red", size = 2
    ),
    switch(specs,
           "nhl" = annotate(
             # dashed white lines atop center line (NHL only)
             "segment",
             x = 0, y = y_max,
             xend = 0, yend = y_min,
             color = "white", size = 0.5, linetype = "dashed"
           ),
           "iihf" = annotate(
             # 50cm space between lines around center dot
             "segment",
             x = 0, y = 0.5,
             xend = 0, yend = -0.5,
             color = "white", size = 2.5
           )
    ),
    ### face-off dot, center ice
    annotate(
      "point",
      x = 0,
      y = 0,
      color = "blue", size = 1
    ),
    ### neutral zone dots
    annotate(
      "point",
      x = (x_blue - x_dot_neutral)*side,
      y = y_faceoff_dot*c(1, -1),
      color = "red", size = 1
    ),
    ### side boards
    annotate(
      "segment",
      x = 0, y = c(y_min, y_max),
      # stop where corner curve begins
      xend = (x_max - r_corner)*side, yend = c(y_min, y_max),
      size = 1
    ),
    ### ends
    # goal line
    annotate(
      "segment",
      x = x_goal*side, y = y_goal,
      xend = x_goal*side, yend = -y_goal,
      color = "red"
    ),
    # connect ends
    annotate(
      "segment",
      x = x_max*side, y = y_curve_end,
      xend = x_max*side, yend = -y_curve_end,
      size = 1
    ),
    # corners rounded in arc of circle
    # starting point: (x_max, y_max) - r_circle from pi/2 to 0
    annotate(
      "path",
      x = ((x_max - r_corner) + r_corner*cos(curve_angle))*side,
      y = (y_max - r_corner) + r_corner*sin(curve_angle),
      size = 1
    ),
    annotate(
      "path",
      x = ((x_max - r_corner) + r_corner*cos(curve_angle))*side,
      y = -((y_max - r_corner) + r_corner*sin(curve_angle)),
      size = 1
    ),
    ### crease
    annotate(
      "segment",
      x = x_goal*side,
      y = crease_start_y*c(-1, 1),
      xend = (x_goal - crease_end)*side,
      yend = crease_start_y*c(-1, 1),
      col = "red"
    ),
    # crease lines
    annotate(
      "segment",
      x = (x_goal - crease_small_start)*side,
      y = crease_start_y*c(-1, 1),
      xend = (x_goal - crease_small_start)*side,
      yend = (crease_start_y - crease_small_length)*c(-1, 1),
      col = "red"
    ),
    # semi-circle starting 137cm out with 183cm radius from center of goal line
    annotate(
      "path",
      x = (x_goal + r_crease*cos(crease_angles))*side,
      y = r_crease*sin(crease_angles),
      col = "red"
    ),
    if (specs == "nhl") {
      ### restricted area (NHL only)
      annotate(
        "segment",
        x = x_goal*side, y = y_traps_start*c(-1, 1),
        xend = x_max*side, yend = y_traps_end*c(-1, 1),
        color = "red"
      )
    },
    ### net
    annotate(
      "segment",
      x = x_goal*side,
      y = goal_post_start*c(-1, 1),
      xend = (x_goal + net_depth)*side,
      yend = goal_post_start*c(-1, 1)
    ),
    annotate(
      "segment",
      x = (x_goal + net_depth)*side,
      y = -goal_post_start,
      xend = (x_goal + net_depth)*side,
      yend = goal_post_start
    ),
    ### face-off circles
    # dot
    annotate(
      "point",
      x = x_faceoff_dot*side,
      y = y_faceoff_dot*c(1, -1),
      col = "red",
      size = 1
    ),
    # circles 
    annotate(
      # top
      "path",
      x = side*(x_faceoff_dot + r_faceoff*cos(circle)),
      y = y_faceoff_dot + r_faceoff*sin(circle),
      col = "red"
    ),
    annotate(
      # bottom
      "path",
      x = side*(x_faceoff_dot + r_faceoff*cos(circle)),
      y = -(y_faceoff_dot + r_faceoff*sin(circle)),
      col = "red"
    ),
    # hashes
    annotate(
      "segment",
      x = side*(
        x_faceoff_dot + (hash_space/2)*rep(c(1, -1), each = 4)
      ),
      y = (y_faceoff_dot + y_hash*c(1, -1))*rep(c(1, 1, -1, -1), times = 2),
      xend = side*(
        x_faceoff_dot + (hash_space/2)*rep(c(1, -1), each = 4)
      ),
      yend = (y_faceoff_dot + (y_hash + hash_length)*c(1, -1))*
        rep(c(1, 1, -1, -1), times = 2),
      col = "red"
    ),
    ## inner lines
    # parallel to side boards
    annotate(
      # parallel to side boards
      "segment",
      x = side*(
        x_faceoff_dot + inner_start_x*rep(c(1, -1), each = 4)
      ),
      y = (y_faceoff_dot + inner_start_y*c(1, -1))*
        rep(c(1, 1, -1, -1), times = 2),
      xend = side*(
        x_faceoff_dot + (inner_start_x + par_side_length)*
          rep(c(1, -1), each = 4)
      ),
      yend = (y_faceoff_dot + inner_start_y*c(1, -1))*
        rep(c(1, 1, -1, -1), times = 2),
      col = "red"
    ),
    annotate(
      # parallel to end boards
      "segment",
      x = side*(
        x_faceoff_dot + inner_start_x*rep(c(1, -1), each = 4)
      ),
      y = (y_faceoff_dot + inner_start_y*c(1, -1))*
        rep(c(1, 1, -1, -1), times = 2),
      xend = side*(
        x_faceoff_dot + inner_start_x*rep(c(1, -1), each = 4)
      ),
      yend = (y_faceoff_dot + (inner_start_y + par_end_length)*c(1, -1))*
        rep(c(1, 1, -1, -1), times = 2),
      col = "red"
    )
  )
}



```

## Introduction
Currently, there are a lot of advanced analytics metrics focusing on [shot quality, defending shots/goals](https://drive4five.blog/2021/01/06/hockey-advanced-statistics-stats-nhl-sports-analytics-aidan-resnick/) and play during even strength.  This year's Big Data Cup focuses on exploring penalty play as a way to gain more insights into various "special teams" strategies. During the Tracking Data Panel at the 2022 Ottawa Hockey Analytics Conference (OTTHAC), measuring defensive performance was posed as the current area of tracking analytics that had the biggest opportunity to add more depth to. Shawn Ferris echoed this sentiment in a 2020 hockey-graphs article where he said [there is still much more to learn about shorthanded defense with respect to understanding optimal in-zone formations and evaluating individual players](https://hockey-graphs.com/2020/04/16/using-data-to-inform-shorthanded-neutral-zone-decisions/#more-24218).  This paper aims to build on the narrative by using 2022 Women's Olympic Hockey event & tracking data to model around successful defensive plays as a way to scout defensive performance during penalty plays. 

A successful defensive play is based on the following event:

**Successful Defensive Plays**: \

+ Takeaway \
+ Unsuccessful Pass \
+ Dump In/Out resulting in change of possession \
+ Blocked Shot attempt \
+ Unsuccessful Zone Entry \
+ Puck Recovery resulting in change of possession \

Current event metrics assign defensive play credit for takeaways, puck recoveries and blocked shots but these events don't account for a majority of events such as passing, zone entry and dump in/out plays. To do so, we rely on tracking movement data to identify the closest opposing player to an offensive player as a way to give credit to a defender for the outcome of the play. The assumption we are using is that the closest defender or the one most prominent in the frame is the one most likely to be contributing to the outcome of a play. Each offensive player is assigned a closest defensive player so it is possible for a defender to be guarding multiple players for a given event. We did not identify the opposing player closest to the location of the actual play given our assumption that the defender guarding the offensive player is again most likely to contribute to the outcome of the play. By merging the event data to the approximate time frame of the tracking data, we can gain valuable insight into the average location and separation at start, leading up to, during the event, and after the event. Additionally, these separation metrics also allows us to identify the closest defenders. 


## Modelling Approach
Using a similar approach to [Jonathan Judge from Baseball Prospectus](https://www.baseballprospectus.com/news/article/38289/bayesian-bagging-generate-uncertainty-intervals-catcher-framing-story/), a Generalized Linear Mixed Effects Model using Monte Carlo Markov Chains (MCMC) was created to identify, which defensive player (based on closest defensive player assignment to each offensive player) had the greatest effect in adjusting the outcome of a defensive play. Our MCMC uses 5 chains and 10,000 iterations per chain to simulate and get an effective total sample size. The modeled dataset contains 1,968 different defensive play matchups (offensive player matched up to closest defensive player) for 507 unique events. In the mixed effects model, we fit the closest defensive player (for each 1,968 matchup) as the random effect modeling for the assumption that a defensive player can alter the result of a play. Through our exploratory analysis, we found that the following fixed variables  determined a successful defensive play: \

+ **Separation**: Avg. offensive player separation or distance to any player on the ice during an event \
+ **Net Separation**: Avg. offensive player separation to the net during an event \
+ **Closest Opposition Player Separation**: Avg. offensive player separation to the closest defender during an event \
+ **Closest Teammate Player Separation**: Avg. offensive player separation to closest teammate during an event \
+ **Absolute x-Distance to Passer/Shooter**: Avg. distance of an offensive player to the passer or shooter \
+ **Absolute x-Distance to Event Recipient**: Avg. distance of an offensive player to the recipient of the event \

All separation and distance variables were centered and scaled to ensure a consistent relative effect of the variables in the model. It is important to note that the tracking data uses Stathletes' Computer Vision technology to identify coordinates of players on ice using the main Olympic television stream. It is possible that there could have been players coming in and out of the camera view. This paper operates under the assumption that the players in frame are important to outcome of the play. 


### Model Results & Evaluation
In viewing the model results, there is evidence (τ00) to show that there is wide variability (0.78) that exists in a defender's ability to alter a play's outcome. This premise gives us basis that there are specialists in the tournament that defend well in power play scenarios. This framework can help to identify those "special teams" players who can be on ice to defend against power plays. Outside of an individual players' ability to defend, an offensive players spacing and separation from each player tends to determine the outcome of a successful play. This tells us that the defender's main goal is to reduce offensive player's separation from anyone on the ice. Another observation is a fairly high Monte Carlo standard error of the variables in the model (typically want roughly less than 5%) and this is likely derived from different event types included in the data.  

```{r a1,echo=FALSE,message=FALSE,warning=FALSE,fig.align='center'}

#gtsummary::tbl_regression(pass.success.mod.mcmc,
#                         broom.mixed::tidyMCMC(pass.success.mod.mcmc)) 


table_sum<-pass.success.mod.mcmc %>%
  broom.mixed::tidyMCMC(
  conf.int = TRUE, conf.level = 0.95,
  estimate.method = "median", conf.method = "HPDinterval"
) %>%
  dplyr::filter(term %in% c('(Intercept)','separation','net_separation','closest_opp_player_separation','closest_event_player_separation',
                            'dis_event_x_abs','dis_event_des_x_abs','sigma','Sigma[defender_id:(Intercept),(Intercept)]')) %>%
  mutate(term = case_when(
    term == "(Intercept)" ~ "Intercept",
    term == "separation" ~ "Separation",
    term == "net_separation" ~ "Net Separation",
    term == "closest_opp_player_separation" ~ "Closest Opposition Player Separation",
    term == "closest_event_player_separation" ~ "Closest Teammate Player Separation",
    term == "dis_event_x_abs" ~ "Absolute x-Distance to Passer/Shooter",
    term == "dis_event_des_x_abs" ~ "Absolute x-Distance to Event Recipient",
    term == "Sigma" ~ "σ",
    term == "Sigma[defender_id:(Intercept),(Intercept)]" ~ "τ00 defender_id",
    TRUE ~ as.character(NA)
  ),
  estimate = round(estimate,2),
  std.error = round(std.error,3),
  conf.low = round(conf.low,2),
  conf.high = round(conf.high,2)
  ) %>%
  rename(
    "CI Low (5%)" = conf.low,
    "CI High (95%)" = conf.high,
    "Std Error" = std.error,
    "Estimates" = estimate,
    "Coefficient" = term 
  )
  

#0.415 * 0.415


table_sum %>%
    gt() %>%
    tab_options(
      column_labels.background.color = "white",
      column_labels.font.weight = "bold",
      table.border.top.width = px(3),
      table.border.top.color = "transparent",
      table.border.bottom.color = "transparent",
      table.border.bottom.width = px(3),
      column_labels.border.top.width = px(3),
      column_labels.border.top.color = "transparent",
      column_labels.border.bottom.width = px(3),
      column_labels.border.bottom.color = "black",
      data_row.padding = px(3),
      source_notes.font.size = 12,
      table.font.size = 12,
      heading.align = "left"
    ) %>%
    opt_table_font(
      font = list(
        google_font("Chivo"),
        default_fonts()
      )
    ) %>%
    tab_header(
      title = md("Defended Play Success Model Summary"),
      subtitle = md("Method: Bayesian MCMC GLM Mixed Effects Model | Chains: 5 | 10,000 Iterations")
    ) %>%
  tab_style(
    style = list(
      cell_fill(color = "#FED8B1")
    ),
    locations = cells_body(
      columns = vars(Coefficient,Estimates,`Std Error`, `CI Low (5%)`,`CI High (95%)`), # not needed if coloring all columns
      rows = 8)
  ) 
#%>%
#  gtsave("DPAA_Play.png")



```


For evaluating the model, we used a PPC (posterior predictive checking) which takes draws from the MCMC and compares the Yrep (expected defended plays in the replicated simulations) to Y (actual defended play results). We saw that the model observed the binomial distribution of the output (successfully defended play or not) fairly well, which leads us to believe there are sufficient modeling results.

The second check is to evaluate whether the distribution has reached a convergence towards the target distribution (can be more difficult with MLE models). We used [Gelman and Rubin’s scale reduction factor](https://mc-stan.org/docs/2_18/reference-manual/notation-for-samples-chains-and-draws.html) or *Rhat*, which helps to show variance within the chains. Typically, you’d want a number near 1 and less than 1.05. The distribution of all variables and intercepts (defensive players) appeared to show a proper convergence of variables within the model (no *Rhat* > 1.05). Given there is evidence of proper variance among defenders and the variables had properly converged, we can conclude that this Bayesian MCMC model can be helpful to use to evaluate defensive play during power plays.



```{r a2,echo=FALSE,message=FALSE,fig.width = 10, fig.height = 3,fig.asp = .62}

color_scheme_set("blue")
a1<-pp_check(pass.success.mod.mcmc) +
  theme(
    legend.position = "top",
    plot.title = element_text(size=25,hjust=0.5),
    axis.text = element_text(size=25),
    legend.text = element_text(size=25)
  ) + 
  labs(
    title = "Posterior Check")
#a1

posterior<-as.matrix(pass.success.mod.mcmc)

a2<-mcmc_areas(posterior, regex_pars = c("separation","dis"), bw = "SJ",
           rhat = rhat(pass.success.mod.mcmc, regex_pars = c("separation","dis"))) +
  theme(
     plot.title = element_text(size=12,hjust=0.5),
     axis.text = element_text(size=10)
  ) +
  labs(
    title = "Convergence Check"
  )

#ggarrange(a1,a2,ncol=2,widths = c(1,2))

#ggsave("Bayesian_check.png")


```


In determining player performance relative to the average, we created a "without defender" metric, which show the probabilistic outcome of the play not accounting for a specific defender's involvement or a normal intercept. The average difference between the MCMC mean and "without defender" metric helps to create our **Defending Plays Above Average (DPAA)** metric. *DPAA* shows the lift in probability a defensive player has on the outcome of a play. Any play with a *DPAA* greater than 0 can be defined as a positively defended play. 

As a result, the model tends to identify Dump In/Outs as the event that has the highest probability of a positively defended event (e.g. Dump In/Outs resulting in a turnover). Takeaways and Puck Recoveries tend to be less positively defended which may be due to a secondary defender's ability to disrupt a play. Passes are one of the most difficult plays to defend given there is a higher probability of a pass being completed successfully than disrupted by a defender.  Given this information, we can also use the *DPAA* metric specifically for passing plays as a way to identify those defenders who were especially effective in disrupting offensive movement during a power play. Shawn Ferris said that "We know that deploying better offensive players, [controlling more entries, and passing after those entries all lead to more shorthanded goals over time](https://hockey-graphs.com/2020/04/16/using-data-to-inform-shorthanded-neutral-zone-decisions/#more-24218)." Players with a reputation of defending the zone line ("blue line") and disrupting passing are more likely to be on the ice during shorthanded defensive play. This also helps to show how proper defensive formations can reduce the performance of offensive passing in the offensive zone. 


```{r a4,echo=FALSE,fig.align='center'}

#pass.frame.sim.preds %>%
#  group_by(event) %>%
#  dplyr::summarize(
#    n = n_distinct(playId),
#    PDAA = mean(fitted.values - wo_defender,na.rm = T)) %>%
#  pivot_wider(names_from = event,values_from = c(PDAA,n)) 


#add Positve Defended Play Pct

avg<-pass.frame.sim.preds %>%
  dplyr::mutate(DPAA = fitted.values - wo_defender,   
                Pos_DPAA = ifelse(DPAA > 0,playId,NA)) %>%
  dplyr::select(playId,x_coord,y_coord,x_coord_2,y_coord_2,DPAA,event,Pos_DPAA) %>%
  mutate(event = case_when(
    event == "Play" ~ "Pass",
    TRUE ~ as.character(event)
  )) %>%
  group_by(event) %>%
  summarize(
            `Event Count` = n_distinct(playId),
            DPAA = round(mean(DPAA,na.rm = T),3),
           `Positive Defended Plays` = n_distinct(Pos_DPAA),
           `Positive Defended Plays %` = round(n_distinct(Pos_DPAA) / n_distinct(playId),2)) %>%
  distinct() %>%
  ungroup() %>%
  arrange(desc(DPAA))

avg %>%
    gt() %>%
  fmt_percent(
    columns = c(`Positive Defended Plays %`),
                decimals = 0
  ) %>%
  cols_label(
      event = "Event",
    ) %>% 
    tab_options(
      column_labels.background.color = "white",
      column_labels.font.weight = "bold",
      table.border.top.width = px(3),
      table.border.top.color = "transparent",
      table.border.bottom.color = "transparent",
      table.border.bottom.width = px(3),
      column_labels.border.top.width = px(3),
      column_labels.border.top.color = "transparent",
      column_labels.border.bottom.width = px(3),
      column_labels.border.bottom.color = "black",
      data_row.padding = px(3),
      source_notes.font.size = 12,
      table.font.size = 12,
      heading.align = "left"
    ) %>%
    opt_table_font(
      font = list(
        google_font("Chivo"),
        default_fonts()
      )
    ) %>%
    tab_header(
      title = md("DPAA Avg by Event"),
      subtitle = md("DPAA:  Defended Plays Above Average | Positively Defended Plays are DPAA > 0")
    ) 
#%>%
#  tab_source_note(
#    source_note = md("Play is a Pass")
#  ) %>%
  

gtsave("DPAA_Event_Avg.png")


  

```


## Tournament Performance Analysis
Using our model, we can evaluate the 2022 Women's Hockey team performance during power plays as well as identify top and bottom individual performers as a way for teams to build a "penalty killer" shift. 

### Team Performance
USA, Finland, and Russian Olympic Committee (ROC) were able to have an average *DPAA* rating greater than 0, largely due to their ability to defend passes. USA is interesting case study given their low amount of passes seen but saw the highest amount of Dump In/Out (18) and Puck Recoveries (36) relative to other countries. In fact, USA had a positive *DPAA* average during Puck Recoveries whereas Switzerland saw negative *DPAA* during Puck Recoveries. As we saw prior, the ability to defend against puck recoveries shows USA's ability to preemptively disrupt passes/shots. USA also had closer separation to opposing players (14.95 ft of separation) compared to any other team. Finland had the highest separation from the players they were guarding (16.78 ft of separation) but the offensive team they were guarding were the most spread out and generally farthest from the net. In short, Finland's strategy was to space out the offense away from the net. ROC had a high amount of passing plays defended positively but overall had the [lowest penalty killing rate](https://www.iihf.com/en/events/2022/olympic-w/teamstats/penaltykilling#statistics) and the highest amount power plays goals against in the tournament at 8.

Canada and Switzerland were the lowest performing teams in defending plays. Canada had 50% of their goals against coming from power play goals despite having the [highest overall goal differential in the Olympics](https://www.iihf.com/en/events/2022/olympic-w/teamstats/goalkeeping#statistics). This is due to their inability to defend passes during penalty play situations leading to the highest average pass distance compared to other teams (i.e. offensive teams were able to spread the Canadian defense). For example, the USA was able to out shoot Canada 53-27 in their first game yet Canada was able to able to win the game, which can likely be attributed to excellent Canadian goaltending. Overall Canada had a slighter higher quality (*DPAA*) of plays defended against compared to Switzerland. The reason for Switzerland having the lowest *DPAA* average was their inability to defend shots given they had the worst *DPAA* shot average and [2nd lowest penalty killing play](https://www.iihf.com/en/events/2022/olympic-w/teamstats/penaltykilling#statistics) during the tournament. 


```{r a5,echo=FALSE,warning=FALSE,message=FALSE,fig.align='center'}




play_plot_df<-pass.frame.sim.preds %>%
  dplyr::mutate(DPAA = fitted.values - wo_defender) %>%
  dplyr::select(playId,closest_defensive_player,DPAA,defender_team,event,pp_index) %>%
  mutate(pos_play = ifelse(DPAA > 0 & event == "Play",playId,NA),
         play = ifelse(event == "Play",playId,NA),
        total_pos = ifelse(DPAA > 0,playId,NA),
    flag_url = case_when(
    defender_team == "USA" ~ "https://upload.wikimedia.org/wikipedia/en/thumb/a/a4/Flag_of_the_United_States.svg/1200px-Flag_of_the_United_States.svg.png",
    defender_team == "Finland" ~ "https://upload.wikimedia.org/wikipedia/commons/thumb/b/bc/Flag_of_Finland.svg/640px-Flag_of_Finland.svg.png",
    defender_team == "ROC" ~ "https://stillmed.olympics.com/media/Images/OlympicOrg/Countries/R/Russian_Federation/CNO-RUS.jpg",
    defender_team == "Switzerland" ~ "https://upload.wikimedia.org/wikipedia/commons/thumb/f/f3/Flag_of_Switzerland.svg/170px-Flag_of_Switzerland.svg.png",
    defender_team == "Canada" ~ "https://upload.wikimedia.org/wikipedia/en/thumb/c/cf/Flag_of_Canada.svg/1200px-Flag_of_Canada.svg.png",
    TRUE ~ as.character(NA)
  )) %>%
  group_by(defender_team,flag_url) %>%
  summarise(
    n = n_distinct(playId,na.rm = TRUE),
    power_plays = n_distinct(pp_index,na.rm = TRUE),
    total_pos = n_distinct(total_pos,na.rm = TRUE),
    play = n_distinct(play,na.rm = TRUE),
    pos_play = n_distinct(pos_play,na.rm = TRUE),
    DPAA = round(as.numeric(as.character(mean(DPAA,na.rm = TRUE))),3)) %>%
  distinct() %>%
  ungroup() %>%
  mutate(
    DPAAPct = round(total_pos / n,2),
    DPAA_Pass_Pct = round(pos_play / play,2)
  ) %>%
  arrange(desc(DPAA)) %>%
  dplyr::select(defender_team,flag_url,DPAA,power_plays,n,DPAAPct,play,DPAA_Pass_Pct)
  
sd<-pass.frame.sim.preds %>%
  mutate(DPAA = fitted.values - wo_defender) %>%
  group_by(defender_team) %>%
  summarize(sd = round(sd(DPAA),3))

play_plot_df<-play_plot_df %>%
  left_join(sd,by=c("defender_team")) %>%
  dplyr::select(defender_team,flag_url,DPAA,sd,power_plays,n,DPAAPct,play,DPAA_Pass_Pct)


####### create GT Table
team_function <- function(data, ...){
  data %>% 
    gt() %>% 
    text_transform(
      locations = cells_body(vars(flag_url)),
      fn = function(x){
        web_image(
          url = x,
          height = px(30)
        )
      }
    ) %>%
      fmt_percent(
    columns = c(DPAAPct,DPAA_Pass_Pct),
                decimals = 0
  ) %>%
    cols_label(
      flag_url = "",
      defender_team = "Defender Team",
      n = "Defending Plays",
      power_plays = "Power Plays",
      DPAAPct = "Positive Defended Plays %",
      play = "Passes",
      DPAA = "DPAA",
      sd = "DPAA SD",
      DPAA_Pass_Pct = "Positive Defended Passing Plays %"
    ) %>% 
   data_color(
      columns = vars(DPAA),
      colors = scales::col_numeric(
        palette = c("#f7c9c9","#f7f7f7","#7fbf7b"),         
        domain = NULL
      )
    ) %>% 
    tab_style(
      style = cell_text(weight = "bold"),
      locations = cells_body(
        columns = vars(defender_team)
      )
    ) %>% 
    tab_options(
      column_labels.background.color = "white",
      column_labels.font.weight = "bold",
      table.border.top.width = px(3),
      table.border.top.color = "transparent",
      table.border.bottom.color = "transparent",
      table.border.bottom.width = px(3),
      column_labels.border.top.width = px(3),
      column_labels.border.top.color = "transparent",
      column_labels.border.bottom.width = px(3),
      column_labels.border.bottom.color = "black",
      data_row.padding = px(3),
      source_notes.font.size = 12,
      table.font.size = 12,
      heading.align = "left",
      ...
    ) %>%
    opt_table_font(
      font = list(
        google_font("Chivo"),
        default_fonts()
      )
    )  %>%
    tab_header(
      title = md("Defended Above Average by Team Play"),
      subtitle = md("Data: Stathletes | Int'l Games: 2022 Winter Olympics")
    ) 
}


play_plot_df %>%
  team_function() 

#%>%
#  gtsave("Team_DPAA.png")


```


Given the majority of the differences in *DPAA* were based on how well the team defends passing, the visual below identifies a team's approach or strategy to defending passes during penalty killing situation. We can see below that the USA tends to defend the blue line very well resulting in less passes in the offensive zone (with exception of top left side). To the contrary, most of Finland's great defensive play was in their zone whereas they tend to not perform well in the neutral zone. ROC is an interesting case study given that they are deploying a [diamond/box defensive formation](https://blueseatblogs.com/2011/10/24/penalty-kill/) and their defensive play appears to be inconsistent as passes through the formation haven't been defended well. Ultimately, ROC's DPAA could have been a lot higher if there were able to defend against pass into their defensive formation. In scouting Canada, they tend to allow a lot of passes into the offensive zone resulting in necessary above average defending in front of the net. Canada needs to replace the top end player in their diamond/box formation or get more aggressive with defending the blue line. 


```{r a6,echo=FALSE,warning=FALSE,message=FALSE,fig.align='center'}


### show a contour of plays by country
team_plot_df<-pass.frame.sim.preds %>%
  dplyr::filter(event %in%  c("Play")) %>%
  dplyr::mutate(DPAA = fitted.values - wo_defender) %>%
  dplyr::select(playId,defender_team,x_coord,y_coord,x_coord_2,y_coord_2,DPAA,event,event_successful) %>%
  group_by(playId,defender_team,event,event_successful) %>%
  summarize(x_coord = mean(x_coord,na.rm = T),
            y_coord = mean(y_coord,na.rm = T),
            x_coord = ifelse(x_coord > 100,200-x_coord,x_coord),
            y_coord = y_coord - 45,
            x_coord = ifelse(x_coord > 90,x_coord - 5,x_coord),
            y_coord = ifelse(y_coord > 30,y_coord - 5,y_coord),
            DPAA = as.numeric(as.character(mean(DPAA,na.rm = T)))) %>%
  distinct() %>%
  ungroup() %>%
  mutate(DPAA_group = case_when(
    DPAA > 0.2 ~ "A. Excellent (0.2+)",
    DPAA <= 0.2 & DPAA > 0 ~ "B. Above Average (0 to 0.2)",
    DPAA < 0 & DPAA >= -0.2 ~ "C. Below Average (-0.2 to 0)",
    DPAA < -0.2 ~ "D. Poor (-0.2 or less)",
    TRUE ~ as.character(NA)
  ),
  flag_url = case_when(
    defender_team == "USA" ~ "https://upload.wikimedia.org/wikipedia/en/thumb/a/a4/Flag_of_the_United_States.svg/1200px-Flag_of_the_United_States.svg.png",
    defender_team == "Finland" ~ "https://upload.wikimedia.org/wikipedia/commons/thumb/b/bc/Flag_of_Finland.svg/640px-Flag_of_Finland.svg.png",
    defender_team == "ROC" ~ "https://stillmed.olympics.com/media/Images/OlympicOrg/Countries/R/Russian_Federation/CNO-RUS.jpg",
    defender_team == "Switzerland" ~ "https://upload.wikimedia.org/wikipedia/commons/thumb/f/f3/Flag_of_Switzerland.svg/170px-Flag_of_Switzerland.svg.png",
    defender_team == "Canada" ~ "https://upload.wikimedia.org/wikipedia/en/thumb/c/cf/Flag_of_Canada.svg/1200px-Flag_of_Canada.svg.png",
    TRUE ~ as.character(NA)
  ))
  

### find distribution 
asp<-1.5
ggplot(data = team_plot_df,aes(x_coord,y_coord)) +
  gg_rink(side="right") +
  stat_density_2d(aes(fill=DPAA_group),geom="polygon",size=5,alpha=0.5) +
  geom_point(aes(x=x_coord,y=y_coord),color="grey",alpha=.4) +
  ggimage::geom_image(aes(x=10,y=-25,image = flag_url),
                      size=.10,by="width",asp=asp) +
  scale_fill_manual(values = c("red", "orange",
                               "light blue", "blue",
                               "green")) +
  facet_wrap(~defender_team,ncol = 3) +
    theme_void() +
    theme(panel.grid = element_blank(),
        axis.line = element_line(),
        axis.ticks=  element_blank(),
        axis.text = element_blank(),
        plot.title = element_text(hjust = .5,size=14,margin=margin(5,0,10,0)),
        plot.subtitle = element_text(hjust = .5,size=10,margin=margin(0,0,15,0)),
        legend.position = "top",
        panel.spacing.x = unit(1,"lines"),
        legend.text = element_text(size=8)
        ) +
  labs(x = "",
       y = "",
       title = "Passing Defense by Country",
       subtitle = "Positioning of Plays Made",
       legend = "DPAA",
       fill = "DPAA") +
  guides(alpha = "none",
         color = guide_legend(override.aes = list(fill = NA)))



#ggsave("Passing_Defense_Country.png")




```

### Individual Performance Analysis

#### Top Performers
To ensure proper scouting of individual performers, simulating the posteriors (using 10,000 iterations) helps to ensure the stability of the MCMC metrics. We can see that players from Finland and USA were the top performers (even after the simulated posteriors). One reason is that these players tend to be closer to the player they are guarding than the average defender (+4ft vs average) with the exception of Megan Keller. Megan Keller was the best of these defenders in the tournament in defending against passes (at least 5 passes), which makes her a valuable specialist to the USA team. Although Viivi Vainikka had the highest *DPAA*, this was due to a majority of her plays coming from successfully defending Dump Ins/Outs (easier plays to defend against). Ronja Savolainen guarded nearly 43 offensive players and had an impressive passing *DPAA* at 0.263. When simulating the posteriors (using 10,000 sims), we can see that she also had the lowest relative standard deviation to her simulated *DPAA* mean, which helps to show her consistent play for Finland and likely a big reason for their positive defense. Here are the top 3 *DPAA* (MCMC mean) defenders for each country (7+ plays): 

**Canada**: 

+ *Marie-Philip Poulin (Center)*: 0.175 \
+ *Blayre Turnbull (Center)*: 0.131 \
+ *Brianne Jenner (Center)*: -0.009 \

**Finland** 

+ *Viivi Vainikka (Center)*: 0.488 \
+ *Minnamari Tuominen (Defense)*: 0.472 \
+ *Ronja Savolainen (Defense)*: 0.264 \

**ROC** 

+ *Oxana Bratishcheva (Center)*: 0.173 \
+ *Nina Pirogova (Center)*: 0.108 \
+ *Olga Sosina (Left Wing)*: 0.068 \

**Switzerland** 

+ *Phoebe Staenz (Center)*: 0.075 \
+ *Noemi Ryhner (Center)*: 0.023 \
+ *Lara Stalder (Center)*: -0.031 \

**USA** 

+ *Megan Keller (Defense)*: 0.477 \
+ *Abby Roque (Center)*: 0.375 \
+ *Amanda Kessel (Center)*: 0.203 \



```{r a7, echo=FALSE,message=FALSE,warning=FALSE,fig.align='center'}

pass_plays<-pass.frame.sim.preds %>%
  mutate(Pass_PDAA = ifelse(event == "Play",fitted.values - wo_defender,NA),
         Pass = ifelse(event == "Play",playId,NA)) %>%
  group_by(defender_id) %>%
  summarize(
    Pass_PDAA = mean(Pass_PDAA,na.rm = T),
    Pass = n_distinct(Pass,na.rm = T),
    Pass = ifelse(is.na(Pass_PDAA),0,Pass),
    Pass_PDAA = ifelse(is.na(Pass_PDAA),NA,Pass_PDAA))

  

tab_data<- defender.sim.mcmc %>%
  left_join(pass_metrics,by=c("defender_id")) %>%
  left_join(pass_plays,by=c("defender_id")) %>%
  mutate(mcmc.mean = round(mcmc.mean,3),
         sim.mean = round(sim.mean,3),
         mcmc.sd = round(mcmc.sd,3),
         sim.sd = round(sim.sd,3),
         dis_event_x_abs = round(abs(dis_event_x_abs),2),
         dis_event_des_x_abs = round(abs(dis_event_des_x_abs),2),
         closest_opp_action_separation = round(abs(closest_opp_action_separation),2),
         closest_opp_player_separation = round(abs(closest_opp_player_separation),2),
         net_separation = round(abs(net_separation),2),
         pass_distance = round(abs(pass_distance),2),
         Pass_PDAA = round(Pass_PDAA,3),
         flag_url = case_when(
           defender_team == "ROC" ~
             "https://www.fotw.info/images/r/ru@oly21.gif",
           defender_team == "Switzerland" ~
             "https://upload.wikimedia.org/wikipedia/commons/thumb/f/f3/Flag_of_Switzerland.svg/170px-Flag_of_Switzerland.svg.png",
           TRUE ~ flag_url
         )) %>%
  arrange(desc(mcmc.mean)) %>%
  filter(
         mcmc.mean > 0,
         n > 6,
         chances > 10) %>%
  ungroup() %>%
  head(5L) %>%
  dplyr::select(closest_defensive_player,position,headshot_url,flag_url,n,mcmc.mean,mcmc.sd,sim.mean,sim.sd,chances,closest_opp_player_separation,Pass,Pass_PDAA)
### figure out pass play event under average

##### top passing defended above average ####
tab_function <- function(data, ...){
  data %>% 
    gt() %>% 
    text_transform(
      locations = cells_body(vars(headshot_url)),
      fn = function(x){
        web_image(
          url = x,
          height = 60
        )
      }
    ) %>% 
    text_transform(
      locations = cells_body(vars(flag_url)),
      fn = function(x){
        web_image(
          url = x,
          height = 30
        )
      }
    ) %>%
    cols_width(vars(flag_url) ~ px(50),
               vars(headshot_url) ~ px(60)) %>%
    cols_label(
      headshot_url = "",
      flag_url = "",
      closest_defensive_player = "Player",
      position = "Position",
      chances = "Off. Players Guarding",
      n = "Plays",
      mcmc.mean = "DPAA",
      mcmc.sd = "DPAA SD",
      sim.mean = "DPAA Sim",
      sim.sd = "DPAA Sim SD",
      closest_opp_player_separation = "Avg. Defender Separation (ft)",
      Pass = "Pass Plays",
      Pass_PDAA = "Pass DPAA"
    ) %>% 
    data_color(
      columns = vars(mcmc.mean),
      colors = scales::col_numeric(
        palette = c("#f7f7f7","#7fbf7b"),         
        domain = NULL
      )
    ) %>% 
    tab_style(
      style = cell_text(weight = "bold"),
      locations = cells_body(
        columns = vars(closest_defensive_player,position)
      )
    ) %>% 
    tab_options(
      column_labels.background.color = "white",
      column_labels.font.weight = "bold",
      table.border.top.width = px(3),
      table.border.top.color = "transparent",
      table.border.bottom.color = "transparent",
      table.border.bottom.width = px(3),
      column_labels.border.top.width = px(3),
      column_labels.border.top.color = "transparent",
      column_labels.border.bottom.width = px(3),
      column_labels.border.bottom.color = "black",
      data_row.padding = px(3),
      source_notes.font.size = 12,
      table.font.size = 12,
      heading.align = "left",
      ...
    ) %>%
    opt_table_font(
      font = list(
        google_font("Chivo"),
        default_fonts()
      )
    )  %>%
    tab_footnote(
      footnote = "Plays include passes, takeaways, dump in/outs, zone entries,shots, puck recoveries (Avg. 8 plays per defender in overall dataset)",
      locations = cells_column_labels(
        columns = n
      )) %>%
    tab_footnote(
      footnote = "DPAA uses 5 MCMC chains",
      locations = cells_column_labels(
        columns = mcmc.mean
      )) %>%
    tab_footnote(
      footnote = "standard deviations for DPAA",
      locations = cells_column_labels(
        columns = mcmc.sd
      ))  %>%
    tab_footnote(
      footnote = "Mean simulation of Posteriors using 10,000 simulations",
      locations = cells_column_labels(
        columns = sim.mean
      ))  %>%
    tab_footnote(
      footnote = "Standard deviation of simulation of Posteriors using 10,000 simulations",
      locations = cells_column_labels(
        columns = sim.sd
      ))  %>%
    tab_header(
      title = md("Top Defending Plays Above Average"),
    subtitle = md("Data: Stathletes | Int'l Games: 2022 Winter Olympics  | Min. 7 Plays defended; DPAA > 0")
  ) %>%
  fmt_missing(
    columns = everything(),
    missing_text = "No Plays"
  )
}

a<-tab_data %>% 
  dplyr::filter(complete.cases(headshot_url)) %>%
  slice(1:10) %>% 
  tab_function()

a 

#%>%
#  gtsave("Top_Performers.png")



```


#### Bottom Performers 

The bottom individual performers were primarily from Canada and Switzerland with the exception of Susanna Tapani from Finland. Higher separation from the players guarding (+4ft vs avg) and total amount of players guarding (40 was 8th highest amount of players closest to) appear to be the top reason for Susanna's performance. Her teammate Ronja Savolainen had guarded a similar amount of players but played closer to defenders on average and saw a better *DPAA* as a result. Alina Marti is another example of how spacing matters given she also had a higher separation and allowed her defenders to play at higher separation from all others on the ice thus translating to their ability to get open. Lastly, it is important to note that the ROC had only 1 negative *DPAA* player despite overall average team *DPAA* (near 0). This leads us to believe their overall defensive formation can be attributed as the reason for their low penalty killing rate. Here are the bottom 3 *DPAA* (MCMC mean) defenders for each country (7+ plays): 


**Canada**: \

+ *Rebecca Johnston (Center)*: -0.219 \
+ *Natalie Spooner (Center)*: -0.187 \
+ *Mich Zandee-Hart (Defense)*: -0.148 \


**Finland** \

+ *Susanna Tapani (Center)*: -0.227 \
+ *Sini Karjalainen (Defense)*: -0.199 \
+ *Ella Viitasuo (Defense)*: -0.040 \


**ROC** \

+ *Fanuza Kadirova (Left Wing)*: -0.088 \
+ *Maria Batalova (Center)*: 0.014 \
+ *Angelina Goncharenko (Defense)*: 0.017 \


**Switzerland** \

+ *Lara Christen (Defense)*: -0.226 \
+ *Nicole Vallario (Defense)*: -0.225 \
+ *Alina Marti (Center)*: -0.218 \

**USA** \

+ *Alex Carpenter (Left Wing)*: -0.143 \
+ *Lee Stecklein (Defense)*: -0.060 \
+ *Dani Cameranesi (Center)*: 0.003 \


*Not listing passing plays below, given a majority/all were passing plays*


```{r a8,echo=FALSE,message=FALSE,warning=FALSE,fig.align='center'}





bot_tab_data<- defender.sim.mcmc %>%
  left_join(pass_metrics,by=c("defender_id")) %>%
    left_join(pass_plays,by=c("defender_id")) %>%
  mutate(mcmc.mean = round(mcmc.mean,3),
         sim.mean = round(sim.mean,3),
         mcmc.sd = round(mcmc.sd,3),
         sim.sd = round(sim.sd,3),
         dis_event_x_abs = round(abs(dis_event_x_abs),2),
         dis_event_des_x_abs = round(abs(dis_event_des_x_abs),2),
         closest_opp_action_separation = round(abs(closest_opp_action_separation),2),
         closest_opp_player_separation = round(abs(closest_opp_player_separation),2),
      Pass_PDAA = round(Pass_PDAA,3),
               flag_url = case_when(
           defender_team == "ROC" ~ "https://www.fotw.info/images/r/ru@oly21.gif",
           defender_team == "Switzerland" ~
             "https://upload.wikimedia.org/wikipedia/commons/thumb/f/f3/Flag_of_Switzerland.svg/170px-Flag_of_Switzerland.svg.png",
           TRUE ~ flag_url),
      headshot_url = case_when(
        closest_defensive_player == "Nicole Vallario" ~ "https://news.stthomas.edu/wp-content/uploads/2022/01/211123mrb120_022.jpg",
        TRUE ~ headshot_url
      )) %>%
  arrange(mcmc.mean) %>%
  filter( n > 6,
         mcmc.mean < 0,
         complete.cases(closest_defensive_player)) %>%
  ungroup() %>%
  head(5L) %>%
  dplyr::select(closest_defensive_player,position,headshot_url,flag_url,n,mcmc.mean,mcmc.sd,sim.mean,sim.sd,chances,closest_opp_player_separation)

#n > 6,
  #head(5L) %>%


bot_tab_function <- function(data, ...){
  data %>% 
    gt() %>% 
    text_transform(
      locations = cells_body(vars(headshot_url)),
      fn = function(x){
        web_image(
          url = x,
          height = 60
        )
      }
    ) %>% 
    text_transform(
      locations = cells_body(vars(flag_url)),
      fn = function(x){
        web_image(
          url = x,
          height = 30
        )
      }
    ) %>%
    cols_width(vars(flag_url) ~ px(50),
               vars(headshot_url) ~ px(60)) %>%
    cols_label(
      headshot_url = "",
      flag_url = "",
      closest_defensive_player = "Player",
      position = "Position",
      chances = "Off. Players Guarding",
      n = "Passes",
      mcmc.mean = "DPAA",
      mcmc.sd = "DPAA SD",
      sim.mean = "DPAA Sim",
      sim.sd = "DPAA Sim SD",
      closest_opp_player_separation = "Avg. Defender Separation (ft)"
    ) %>% 
    data_color(
      columns = vars(mcmc.mean),
      colors = scales::col_numeric(
        palette = c("#ee8181","#f7c9c9"),         
        domain = NULL
      )
    ) %>% 
    tab_style(
      style = cell_text(weight = "bold"),
      locations = cells_body(
        columns = vars(closest_defensive_player,position)
      )
    ) %>% 
    tab_options(
      column_labels.background.color = "white",
      column_labels.font.weight = "bold",
      table.border.top.width = px(3),
      table.border.top.color = "transparent",
      table.border.bottom.color = "transparent",
      table.border.bottom.width = px(3),
      column_labels.border.top.width = px(3),
      column_labels.border.top.color = "transparent",
      column_labels.border.bottom.width = px(3),
      column_labels.border.bottom.color = "black",
      data_row.padding = px(3),
      source_notes.font.size = 12,
      table.font.size = 12,
      heading.align = "left",
      ...
    ) %>%
    opt_table_font(
      font = list(
        google_font("Chivo"),
        default_fonts()
      )
    )  %>%
    tab_footnote(
      footnote = "Plays include passes, takeaways, dump in/outs, zone entries,shots, puck recoveries (Avg. Player had 8 plays apart of)",
      locations = cells_column_labels(
        columns = n
      )) %>%
    tab_footnote(
      footnote = "DPAA uses 5 MCMC chains",
      locations = cells_column_labels(
        columns = mcmc.mean
      )) %>%
    tab_footnote(
      footnote = "standard deviations for DPAA",
      locations = cells_column_labels(
        columns = mcmc.sd
      ))  %>%
    tab_footnote(
      footnote = "Simulation of Posteriors using 10,000 simulations",
      locations = cells_column_labels(
        columns = sim.mean
      ))  %>%
    tab_header(
      title = md("Bottom Defending Plays Above Average"),
      subtitle = md("Data: Stathletes | Int'l Games: 2022 Winter Olympics  | Min. 7 Plays defended; DPAA < 0")
    ) %>%
  fmt_missing(
    columns = everything(),
    missing_text = "No Plays"
  )
}




bot_tab_data %>%
bot_tab_function() 

#%>%
#  gtsave("Bottom_perf.png")

```


#### High Volume Performers
Below shows defenders with the highest amount of involvement and helps us to provide insights into the scheme assignment given out to shorthanded defenders. As we can see, most players are fitting into a diamond/box format given the concentration of defending plays made. The exception is Jocelyne Larocque (Canada) who has been defending the boards, which may have contributed to her below average play given she had to guard a wider zone. The same goes for Mich Zandee-Hart (Canada) who was stretched to play in three different parts of the diamond/box format. Canada may want to play into a tighter box/diamond format or have players play more disciplined to their zone assignment as a way to prevent and spread out passes for future games. Ronja Savolainen played mostly towards the blue line with some plays made in the neutral zone. The difference with her play versus Mich was that Ronja played at 13ft seperation vs Mich played at 21ft separation (nearly +6 vs avg). Jenni Hiirikoski, similar to Ronja Savolainen, also played 13ft to her defender and strictly to what appears to be an assigned zone. A defensive zone formation would helped to tighten average separation to the closest offensive player and increased positive defended plays as defenders would play to their assigned zone. 


```{r a9,echo=FALSE,message=FALSE,warning=FALSE,fig.align='center'}


### top defenders
##    "Viivi Vainikka",
##    "Megan Keller",
##    "Minnamari Tuominen",
##    "Abby Roque",
##    "Ronja Savolainen"

plot_df<-pass.frame.sim.preds %>%
  dplyr::filter(closest_defensive_player %in% c(
    "Jocelyne Larocque",
    "Sarah Forster",
    "Michelle Karvinen",
    "Ronja Savolainen",
    "Jenni Hiirikoski",
    "Mich Zandee-Hart"
  )) %>%
  dplyr::mutate(DPAA = fitted.values - wo_defender) %>%
  dplyr::select(playId,closest_defensive_player,x_coord,y_coord,x_coord_2,y_coord_2,DPAA,event,event_successful,defender_team) %>%
  group_by(playId,closest_defensive_player,event,event_successful,defender_team) %>%
  summarize(x_coord = mean(x_coord,na.rm = T),
            y_coord = mean(y_coord,na.rm = T),
            x_coord = ifelse(x_coord > 100,200-x_coord,x_coord),
            y_coord = y_coord - 45,
            x_coord = ifelse(x_coord > 90,x_coord - 5,x_coord),
            y_coord = ifelse(y_coord > 30,y_coord - 5,y_coord),
            DPAA = as.numeric(as.character(mean(DPAA,na.rm = T)))) %>%
  distinct() %>%
  ungroup() %>%
  mutate(DPAA_group = case_when(
    DPAA > 0.2 ~ "A. Excellent (0.2+)",
    DPAA <= 0.2 & DPAA > 0 ~ "B. Above Average (0 to 0.2)",
    DPAA < 0 & DPAA >= -0.2 ~ "C. Below Average (-0.2 to 0)",
    DPAA < -0.2 ~ "D. Poor (-0.2 or less)",
    TRUE ~ as.character(NA)
    )
    ,
  flag_url = case_when(
    defender_team == "USA" ~ "https://upload.wikimedia.org/wikipedia/en/thumb/a/a4/Flag_of_the_United_States.svg/1200px-Flag_of_the_United_States.svg.png",
    defender_team == "Finland" ~ "https://upload.wikimedia.org/wikipedia/commons/thumb/b/bc/Flag_of_Finland.svg/640px-Flag_of_Finland.svg.png",
    defender_team == "ROC" ~ "https://stillmed.olympics.com/media/Images/OlympicOrg/Countries/R/Russian_Federation/CNO-RUS.jpg",
    defender_team == "Switzerland" ~ "https://upload.wikimedia.org/wikipedia/commons/thumb/f/f3/Flag_of_Switzerland.svg/170px-Flag_of_Switzerland.svg.png",
    defender_team == "Canada" ~ "https://upload.wikimedia.org/wikipedia/en/thumb/c/cf/Flag_of_Canada.svg/1200px-Flag_of_Canada.svg.png",
    TRUE ~ as.character(NA)
  ),
  y_coord = y_coord + 4) %>%
  arrange(match(closest_defensive_player,c( 
    "Jocelyne Larocque",
    "Sarah Forster",
    "Michelle Karvinen",
    "Ronja Savolainen",
    "Jenni Hiirikoski",
    "Mich Zandee-Hart"
    )))
  
neworder<-c(     
    "Jocelyne Larocque",
    "Sarah Forster",
    "Michelle Karvinen",
    "Ronja Savolainen",
    "Jenni Hiirikoski",
    "Mich Zandee-Hart"
  )
#img_AV<-readPNG(getURLContent('https://upload.wikimedia.org/wikipedia/commons/thumb/b/bc/Flag_of_Finland.svg/640px-Flag_of_Finland.svg.png'))

new_plot<-plot_df
new_plot$group<-factor(new_plot$closest_defensive_player,
                       levels=c(    
    "Jocelyne Larocque",
    "Sarah Forster",
    "Michelle Karvinen",
    "Ronja Savolainen",
    "Jenni Hiirikoski",
    "Mich Zandee-Hart"
    ))

new_plot<-new_plot %>%
  mutate(group = case_when(
    group == "Jocelyne Larocque" ~ "1. Jocelyne Larocque | DPAA: -0.029",
    group == "Sarah Forster" ~ "2. Sarah Forster | DPAA: -0.090",
    group == "Michelle Karvinen" ~ "3. Michelle Karvinen | DPAA: -0.022",
    group == "Ronja Savolainen" ~ "4. Ronja Savolainen | DPAA: 0.264",
    group == "Jenni Hiirikoski" ~ "5. Jenni Hiirikoski | DPAA: 0.119",
    group == "Mich Zandee-Hart" ~ "6. Mich Zandee-Hart | DPAA: -0.148",
    TRUE ~ as.character(NA)
  ))

#asp<-2.5

#new_plot %>%
asp<-1.5
ggplot(data = new_plot,aes(x_coord,y_coord)) +
  gg_rink(side="right") +
  stat_density_2d(aes(fill=..level..,alpha=(..level..)^4),geom="polygon",size=1,show.legend = F) +
  #geom_density_2d(aes(fill=..level..,alpha=..level..),color="light grey") +
  #geom_density_2d_filled(contour_var = "count") +
  geom_point(aes(x=x_coord,y=y_coord,size=DPAA),alpha=.1) +
  ggimage::geom_image(aes(x=10,y=-25,image = flag_url),
                      size=.10,by="width",asp=asp) +
  scale_fill_distiller(palette = 2,direction = 1) +
  facet_wrap(~group,ncol = 3) +
    theme_void() +
    theme(panel.grid = element_blank(),
        axis.line = element_line(),
        axis.ticks=  element_blank(),
        axis.text = element_blank(),
        plot.title = element_text(hjust = .5,size=14,margin=margin(5,0,10,0)),
        plot.subtitle = element_text(hjust = .5,size=10,margin=margin(0,0,15,0)),
        legend.position = "top",
        panel.spacing.x = unit(1,"lines"),
        legend.text = element_text(size=6),
        plot.caption = element_text(size=7)
        ) +
  labs(x = "",
       y = "",
       title = "High Volume Defender Comparison",
       legend = "DPAA",
       fill = "DPAA",
       caption = "These defenders were listed as the closest defensive player for the highest amount of plays") +
  guides(alpha = "none",
         color = guide_legend(override.aes = list(fill = NA)))






```


## Conclusion
*DPAA* can be an effective metric to evaluate defensive plays during penalty situations. The direct application of *DPAA* can be used to evaluate overall team performance as well as isolating individual defenders who performed above/below expectations. An insight from the model was for defenders to aim to be within 15ft of the offensive players they are guarding. A zone assignment would install a system that ensures players are playing with 15ft of the nearest offensive player and prevent a player from getting open. Results from the model said that defending passes has the lowest probability of a positive defended play and DumpIn/Outs had the highest probability of a positive defended play. This is why taking the USA strategy of playing the blue line aggressively as a way to prevent passing plays from occurring is the optimal strategy. Ideally, the players at the top of the zone formation are your more athletic/quicker skaters to be able to reduce offensive separation, prevent zone entries and not be forced to guard many offensive players. 

*DPAA* could be expanded to even strength situations given the proportion of passes but we would hypothesize that zone entry carries would likely play a greater role in the model (given less proportion of zone entries during power plays). The model would also need to be changed to take into account play situation given we would want to investigate even strength vs special teams play as a performance metric. I would want to build on *DPAA* to be the foundation to advance shorthanded defense evaluation by being the anchor metric in classifying different forechecking and in-zone formations.

Lastly, I would like to thank Stathletes and the OTTHAC for facilitating and providing the data for the Big Data Cup. It is a privilege to be able to work with data like this and competitions such as this helps to advance the game as we know as well as develop skills of the analytics community. 



## References
Brooks, D., Judge, J., Pavlidis, H. "Moving Beyond WOWY: A Mixed Approach To Measuring Catch Framing." Baseball Prospectus. February 5, 2015. https://www.baseballprospectus.com/news/article/25514/moving-beyond-wowy-a-mixed-approach-to-measuring-catcher-framing/

Eisenberg, D., Raber, M. "Defensive Efficiency Metrics (DEMs): A Paradigm Shift in Defensive Hockey Analysis Based on Per-Possession Measurements." March 26, 2021. 
https://www.statsportsconsulting.com/wp-content/uploads/Deffensive-Efficiency-Metrics-DEMs.pdf

Ferris, Shawn. "Using Data To Inform Shorthanded Neutral Zone Decisions." Hockey-Graphs. April 16, 2020.
https://hockey-graphs.com/2020/04/16/using-data-to-inform-shorthanded-neutral-zone-decisions/#more-24218

Judge, Jonathan. "Bayesian Bagging to Generate Uncertainty Intervals: A Catcher Framing Story." Baseball Prospectus. March 7, 2018. https://www.baseballprospectus.com/news/article/38289/bayesian-bagging-generate-uncertainty-intervals-catcher-framing-story/

Kay, Matthew. "Extracting and Visualizing Tidy Draws From Rstanarm Models". tidybayes. December 30, 2021. http://mjskay.github.io/tidybayes/articles/tidy-rstanarm.html

```{r a10,echo=FALSE,message=FALSE,warning=FALSE}

name<-"Sarah Nurse"
title<-"'s DPAA Performance"
headshot_url<-"http://d2a3o6pzho379u.cloudfront.net/136867.jpg"
plyr<-paste(name,title,sep="")

card_plot_df<-pass.frame.sim.preds %>%
  dplyr::filter(closest_defensive_player %in%
    name
  ) %>%
  dplyr::mutate(DPAA = fitted.values - wo_defender) %>%
  dplyr::select(playId,closest_defensive_player,x_coord,y_coord,x_coord_2,y_coord_2,DPAA,event,event_successful,defender_team) %>%
  group_by(playId,closest_defensive_player,event,event_successful,defender_team) %>%
  summarize(x_coord = mean(x_coord,na.rm = T),
            y_coord = mean(y_coord,na.rm = T),
            x_coord = ifelse(x_coord > 100,200-x_coord,x_coord),
            y_coord = y_coord - 45,
            x_coord = ifelse(x_coord > 90,x_coord - 5,x_coord),
            y_coord = ifelse(y_coord > 30,y_coord - 5,y_coord),
            DPAA = as.numeric(as.character(mean(DPAA,na.rm = T)))) %>%
  distinct() %>%
  ungroup() %>%
  mutate(DPAA_group = case_when(
    DPAA > 0.2 ~ "A. Excellent (0.2+)",
    DPAA <= 0.2 & DPAA > 0 ~ "B. Above Average (0 to 0.2)",
    DPAA < 0 & DPAA >= -0.2 ~ "C. Below Average (-0.2 to 0)",
    DPAA < -0.2 ~ "D. Poor (-0.2 or less)",
    TRUE ~ as.character(NA)
    ),
    headshot_url = "http://d2a3o6pzho379u.cloudfront.net/136867.jpg",
  flag_url = case_when(
    defender_team == "USA" ~ "https://upload.wikimedia.org/wikipedia/en/thumb/a/a4/Flag_of_the_United_States.svg/1200px-Flag_of_the_United_States.svg.png",
    defender_team == "Finland" ~ "https://upload.wikimedia.org/wikipedia/commons/thumb/b/bc/Flag_of_Finland.svg/640px-Flag_of_Finland.svg.png",
    defender_team == "ROC" ~ "https://stillmed.olympics.com/media/Images/OlympicOrg/Countries/R/Russian_Federation/CNO-RUS.jpg",
    defender_team == "Switzerland" ~ "https://upload.wikimedia.org/wikipedia/commons/thumb/f/f3/Flag_of_Switzerland.svg/170px-Flag_of_Switzerland.svg.png",
    defender_team == "Canada" ~ "https://upload.wikimedia.org/wikipedia/en/thumb/c/cf/Flag_of_Canada.svg/1200px-Flag_of_Canada.svg.png",
    TRUE ~ as.character(NA)
  ),
  y_coord = y_coord + 4) %>%
  arrange(match(closest_defensive_player,c( 
    "Sarah Nurse"
    )))
  
neworder<-c(     
"Sarah Nurse"
  )
#img_AV<-readPNG(getURLContent('https://upload.wikimedia.org/wikipedia/commons/thumb/b/bc/Flag_of_Finland.svg/640px-Flag_of_Finland.svg.png'))

new_plot<-card_plot_df
new_plot$group<-factor(new_plot$closest_defensive_player,
                       levels=c(    
    "Sarah Nurse"
    ))

#asp<-2.5


g1<-new_plot %>%
  group_by(event) %>%
  summarize(DPAA = round(mean(DPAA),3),
            Val = n()) %>%
  ggplot() +
  aes(x=event,y=DPAA) +
  geom_bar(stat="identity",fill="red") +
  geom_text(aes(label=DPAA), vjust=-0.9, hjust=-1.5,color="white", size=3.5) +
  geom_text(aes(label=Val), vjust=-0.9, hjust='bottom',color="white", size=3.5) +
  coord_flip() +
  theme_minimal() +
  labs(
    y="",
    title = "DPAA by Event"
  ) +
  theme(
    axis.text.x = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    plot.title = element_text(size=10,margin=margin(5,0,10,0))
  )




player_comp<-pass.frame.sim.preds %>%
  mutate(Comparison = ifelse(closest_defensive_player == name,name,"All Other"))

g2<-player_comp %>%
  dplyr::mutate(DPAA = fitted.values - wo_defender) %>%
  filter(Comparison != "NA") %>%
ggplot() +
  aes(x=DPAA,fill=Comparison) +
        geom_density(alpha=0.6) +
  scale_fill_manual(
    values = c(
      'grey','red'
    )
  ) +
  theme_minimal() + 
      theme(panel.grid = element_blank(),
        axis.line = element_line(),
        plot.title = element_text(hjust = .5,size=10,margin=margin(5,0,10,0)),
        plot.subtitle = element_text(hjust = .5,size=10,margin=margin(0,0,15,0)),
        legend.position = "top",
        panel.spacing.x = unit(1,"lines"),
        legend.text = element_text(size=6),
        plot.caption = element_text(size=7),
        legend.title = element_text(size=7)
        ) +
  labs(title = "DPAA Comparison",
       y="")

g3<-player_comp %>%
  dplyr::mutate(DPAA = fitted.values - wo_defender) %>%
  filter(Comparison != "NA") %>%
ggplot() +
  aes(x=fitted.values,fill=Comparison) +
        geom_density(alpha=0.6) +
  scale_fill_manual(
    values = c(
      'grey','red'
    )
  ) +
  theme_minimal() + 
      theme(panel.grid = element_blank(),
        axis.line = element_line(),
        plot.title = element_text(hjust = .5,size=10,margin=margin(5,0,10,0)),
        plot.subtitle = element_text(hjust = .5,size=10,margin=margin(0,0,15,0)),
        legend.position = "top",
        panel.spacing.x = unit(1,"lines"),
        legend.text = element_text(size=6),
        plot.caption = element_text(size=7),
        legend.title = element_text(size=7)
        ) +
  labs(title = "Play Exp. Outcome Comparison",
       x = "W/O Defender Exp. Outcome",
       y="")
  


#new_plot %>%
asp<-1.5
g4<-ggplot(data = new_plot,aes(x_coord,y_coord)) +
  gg_rink(side="right") +
  stat_density_2d(aes(fill=..level..,alpha=(..level..)^4),geom="polygon",size=1,show.legend = F) +
  #geom_density_2d(aes(fill=..level..,alpha=..level..),color="light grey") +
  #geom_density_2d_filled(contour_var = "count") +
  geom_point(aes(x=x_coord,y=y_coord,size=DPAA),alpha=.1) +
  ggimage::geom_image(aes(x=10,y=-25,image = flag_url),
                      size=.10,by="width",asp=asp) +
  ggimage::geom_image(aes(x=10,y=30,image=headshot_url),
                      size=.10,by="width",asp=asp) +
  scale_fill_distiller(palette = 8,direction = 1) +
    theme_void() +
    theme(panel.grid = element_blank(),
        axis.line = element_line(),
        axis.ticks=  element_blank(),
        axis.text = element_blank(),
        plot.title = element_text(hjust = .5,size=10,margin=margin(5,0,10,0)),
        plot.subtitle = element_text(hjust = .5,size=10,margin=margin(0,0,15,0)),
        legend.position = "none",
        panel.spacing.x = unit(1,"lines"),
        legend.text = element_text(size=6),
        plot.caption = element_text(size=7)
        ) +
  labs(x = "",
       y = "",
       title = "DPAA Play Location",
       legend = "DPAA",
       fill = "DPAA") +
  guides(alpha = "none",
         color = guide_legend(override.aes = list(fill = NA)))



top_row<-ggarrange(g1,g2,g3,ncol=3)
bottom_row<-ggarrange(NULL,g4,NULL,ncol=3,widths = c(1,2,1))
figure<-ggarrange(top_row,bottom_row,ncol=1)

annotate_figure(figure,
                top = text_grob(plyr, color = "red", face = "bold", size = 14),
                bottom = text_grob("Data source: \n Stathletes", color = "black",
                                   hjust = 1, x = 1, face = "italic", size = 10)
                )


```



